<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>SCU Note Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/css/sidebar-menu.css">
    <link href="/css/navbar.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="/css/userDepository.css">
    <script src="https://cdn.staticfile.org/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="/js/jquery.contextify.js"></script>

    <script src="/js/jquery.ui.position.min.js" type="text/javascript"></script>
    <script src="/js/contextMenu.js" type="text/javascript"></script>
    <link href="/css/contextMenu.css" rel="stylesheet" type="text/css"/>
    <link href="/css/popUpBox.css" rel="stylesheet" type="text/css"/>
</head>

<body>
<div id="content">
    <ul class="button-list">
        <li><a href='javascript:;' class='button' onClick="return false;">Home</a></li>
        <li class="search"><input id="toSearchName" type="text" class="search-input" name="search" value="Search"
                                  onClick="$(this).val('');"/><input type="submit" class="search-submit"/></li>
    </ul>
</div>
<aside class="main-sidebar">
    <section class="sidebar">
        <ul class="sidebar-menu">
            <li class="header">功能列表</li>
            <li class="treeview">
                <a href="javascript:;">
                    <i class="fa fa-address-card-o"></i>
                    <span class="toUserInfo">用户信息</span>
                </a>
            </li>
            <li class="treeview">
                <a href="javascript:;">
                    <i class="fa fa-pie-chart"></i>
                    <span>仓库管理</span>
                    <i class="fa fa-angle-left pull-right"></i>
                </a>
                <ul class="treeview-menu">
                    <li><a href="javascript:;"><i class="fa fa-circle-o"></i>添加note仓库</a></li>
                </ul>
            </li>
            <li class="treeview">
                <a href="javascript:;">
                    <i class="fa fa-laptop"></i>
                    <span>文件管理</span>
                    <i class="fa fa-angle-left pull-right"></i>
                </a>
                <ul class="treeview-menu">
                    <li><a href="javascript:;"><i class="fa fa-circle-o"></i>上传文件</a></li>
                </ul>
            </li>
            <li class="treeview">
                <a href="javascript:;">
                    <i class="fa fa-edit"></i> <span class="toAuthority">协作者管理</span>
                </a>
            </li>
            <li class="header">其他功能</li>
            <li><a href="javascript:;"><i class="fa fa-circle-o text-red"
                                          style="color:red"></i><span>退出登录</span></a></li>
        </ul>
    </section>
</aside>
<script src="/js/sidebar-menu.js"></script>
<script>
    $.sidebarMenu($('.sidebar-menu'))
</script>
<div class="functionBlock">
    <div class="toolsBlock">
        <div class="line" id="addDepository">创建note仓库</div>
        <div class="line" id="addDirectior">创建文件夹</div>
        <div class="line" id="uploadFile">上传文件</div>
    </div>
    <div class="depositoryBlock">
        <!-- <div class="block">
            <image src="/imgs/depository2.png" mode="aspectFit" />
            <div class="blockTitle">文件夹名字</div>
        </div> -->
    </div>
</div>
<!-- <div class="popUpBox" style="display:none;">
    <div class="lineStyle">
        <label>仓库名</label>
        <input placeholder="Please enter your depository name" type="text" name="depositoryName"
            class="" id="depositoryName">
    </div>
    <div class="lineStyle">
        <label>大分类</label>
    </div>
    <div class="lineStyle">
        <label>小分类</label>
    </div>
    <div class="lineStyle">
        <label>可见性</label>
    </div>
</div> -->
<!-- 模态框（Modal） -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel">
                    添加note仓库
                </h4>
            </div>
            <div class="modal-body">
                <div class="lineStyle">
                    <label>仓库名</label>
                    <input placeholder="请输入仓库名" type="text" name="depositoryName"
                           class="" id="depositoryName">
                </div>
                <div class="lineStyle">
                    <label>大分类</label>
                    <div class="btn-group dropdown" id="dropdown">
                        <button type="button" class="btn btn-default dropdown-toggle modifySize" data-toggle="dropdown"
                                aria-haspopup="true" aria-expanded="false" id="selectClassfy">
                            理学 <span class="caret"></span>
                        </button>
                        <input type="hidden" name="classfy" id="classfy" value="理学"/>
                        <ul class="dropdown-menu">
                            <li><a href="javascript:;" data-num="1" class="classfyName">哲学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="2" class="classfyName">经济学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="3" class="classfyName">法学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="4" class="classfyName">教育学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="5" class="classfyName">文学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="6" class="classfyName">历史学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="7" class="classfyName">理学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="8" class="classfyName">工学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="9" class="classfyName">农学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="10" class="classfyName">医学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="11" class="classfyName">军事学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="12" class="classfyName">管理学</a></li>
                            <li role="separator" class="divider"></li>
                            <li><a href="javascript:;" data-num="13" class="classfyName">艺术学</a></li>
                        </ul>
                    </div>
                </div>
                <div class="lineStyle smallClassfyWrapper">
                    <label>小分类</label>
                    <input placeholder="请输入小分类名" type="text" class="addingSmallClassfyFiled"/>
                    <input type="button" value="添加" class="addSmall"/>
                    <div class="smallClassfyFiled">
<!--                        <div class="smallClassfy">逗逼</div>-->
                    </div>
                </div>
                <div class="lineStyle">
                    <label>可见性</label>
                    <input class="radio" type="radio" checked="checked" name="visibility" value="notVisibility"/><span>不公开</span>
                    <input class="radio" type="radio" name="visibility" value="visibility"/><span>公开</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" >关闭
                </button>
                <button type="button" class="btn btn-primary" id="submitAddRequest">
                    提交
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<div class="modal fade" id="addDirectiorModel" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                    &times;
                </button>
                <h4 class="modal-title" id="myModalLabel2">
                    添加文件夹
                </h4>
            </div>
            <div class="modal-body">
                <div class="lineStyle">
                    <label>文件夹名</label>
                    <input placeholder="请输入文件夹名" type="text" name="directoryName"
                           class="" id="directoryName">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal" id="">关闭
                </button>
                <button type="button" class="btn btn-primary" id="submitAddDirectoryRequest">
                    提交
                </button>
            </div>
        </div><!-- /.modal-content -->
    </div><!-- /.modal -->
</div>
<script>
    var searchUrl = window.location.href;
    var searchData = searchUrl.split("="); //截取 url中的“=”,获得“=”后面的参数
    var searchText = decodeURI(searchData[1]); //decodeURI解码
    console.log(searchText);
    $(function () {
        var depositoryClassification = [
            "哲学", "经济学", "法学", "教育学", "文学", "历史学",
            "理学", "工学", "农学", "医学", "军事学", "管理学", "艺术学"
        ];
        var depositories = [];
        var userInfo = {};
        var classfyIdNum = 7;
        var smallClassfy = "";
        var filePath = "";

        $.ajax({
            type: "POST",
            url: "/userInfo",
            contentType: 'application/x-www-form-urlencoded;charset=utf-8',
            async: false,
            data: {
                userId: searchText
            },
            dataType: "json",
            success: function (data) {
                console.log(data);
                depositories = data.depositories;
                userInfo = data.user;
                for (var i in depositories) {
                    var imgSrc = "/imgs/depository2.png";
                    var className = "block";
                    console.log(depositories[i])
                    // if (depositories[i].charAt(0) === 'f') {
                    //     imgSrc = "/imgs/files.png";
                    //     className = "file";
                    // }
                    $("<div>", {
                        id: depositories[i].depository.depositoryId,
                        "class": className,
                        "data-id": depositories[i].depository.depositoryId,
                        click: function (e) {
                            console.log(this)
                            $('#' + depositories[i].depository.depositoryId).contextMenu();
                        }
                    }).appendTo(".depositoryBlock");
                    var image = $("<image src=" + imgSrc + " mode='aspectFit' />");
                    $("#" + depositories[i].depository.depositoryId).append(image);
                    $("<div>", {
                        "class": "blockTitle",
                        "text": depositories[i].depository.depositoryName
                    }).appendTo("#" + depositories[i].depository.depositoryId);
                }
            },
            error: function (e) {
                console.log(e);
            }
        });

        $.contextMenu({
            selector: '.block',
            callback: function (key, options) {
                console.log("点击了：" + key);
                console.log(options.$trigger[0]);
                console.log(options.$trigger[0].id)
                if (key == "打开")  {
                    filePath += options.$trigger[0].id
                    $.ajax({
                        type: "post",
                        url: "http://101.132.112.132:8088/scu_notes/search/directory.do",
                        data: {
                            directories: filePath
                        },
                        dataType: "json",
                        success: function (data) {
                            $(".depositoryBlock").empty();
                            console.log(data);
                            if (data) {
                                filePath += '/';
                                var rep=/[\.]/;
                                for (var i in data) {
                                    var imgSrc = "/imgs/depository2.png";
                                    var className = "block";
                                    console.log(data[i])
                                    if(rep.test(data[i])) {
                                        imgSrc = "/imgs/files.png";
                                        className = "file";
                                    }
                                    $("<div>", {
                                        id: data[i],
                                        "class": className
                                    }).appendTo(".depositoryBlock");
                                    var image = $("<image src=" + imgSrc + " mode='aspectFit' />");
                                    $("#" + data[i]).append(image);
                                    $("<div>", {
                                        "class": "blockTitle",
                                        "text": data[i]
                                    }).appendTo("#" + data[i]);
                                }
                            } else {
                                alert("没有文件或文件夹")
                            }
                        },
                        error: function (e) {
                            console.log(e);
                        }
                    });
                } else {
                    $.ajax({
                        type: "post",
                        url: "/depository/setVisibleById",
                        data: {
                            visible: 'true',
                            depositoryId: options.$trigger[0].id
                        },
                        dataType: "json",
                        success: function (data) {
                            console.log(data);
                            alert("设置公开成功")
                        },
                        error: function (e) {
                            console.log(e);
                        }
                    });
                }
            },
            items: {
                "打开": {
                    name: "打开",
                    icon: ""
                },
                "sep1": "---------",
                "公开": {
                    name: "设置公开",
                    icon: "edit"
                },
            }
        });
        $.contextMenu({
            selector: '.file',
            callback: function (key, options) {
                console.log("点击了：" + key);
                console.log(options);
                alert("暂时无法查看文件");
            },
            items: {
                "打开": {
                    name: "打开",
                    icon: ""
                }
            }
        });


        $('#addDepository').click(function () {
            $('#myModal').modal('show')
        });

        $(".toUserInfo").click(function () {
            var toUserInfo = encodeURI("/userInfoPage?userId=" + userInfo.userId + "&userName=" + userInfo.username); //使用encodeURI编码
            location.href = toUserInfo;
        });

        $(".toAuthority").click(function () {
            var toAuthority = encodeURI("/authorityPage?userId=" + userInfo.userId); //使用encodeURI编码
            location.href = toAuthority;
        });

        // $("#uploadFile").click(function () {
        //
        //
        // });

        $(".classfyName").click(function (e) {
            console.log(e.currentTarget.attributes[1].value)
            classfyIdNum = e.currentTarget.attributes[1].value;
            $('#selectClassfy').text(depositoryClassification[e.currentTarget.attributes[1].value - 1]);
        });

        $('#addDirectior').click(function (e) {
            $('#addDirectiorModel').modal('show')
        });

        $('#submitAddDirectoryRequest').click(function () {
            var directoryName = "";
            if ($("#directoryName").val()) {
                directoryName = $("#directoryName").val();
            } else {
                alert("请输入文件夹名");
                return;
            }
            $.ajax({
                    type: "post",
                    url: "http://101.132.112.132:8088/scu_notes/create/directory.do",
                    data: {
                        directories : filePath,
                        newDirectory: directoryName
                    },
                    dataType: "json",
                    success: function (data) {
                        console.log(data);
                    },
                    error: function (e) {
                        console.log(e);
                    }
                });

        })

        $(".addSmall").click(function (e) {
            if($('.addingSmallClassfyFiled').val()) {
                $("<div>", {
                    "class": 'smallClassfy',
                    "text": $('.addingSmallClassfyFiled').val()
                }).appendTo(".smallClassfyFiled");
                smallClassfy += $('.addingSmallClassfyFiled').val();
                smallClassfy += ";";
            } else {
                alert("请输入小分类名")
            }

        });

        $("#submitAddRequest").click(function () {

            var depositoryName = "";
            var depositoryOwnerId = searchText;
            var depositoryVisible = false;
            var depositoryClassificationId = 1;
            var tags = smallClassfy;

            console.log($('.radio'))
            if (!$('.radio')[0].checked) {
                depositoryVisible = true;
            }
            if ($("#depositoryName").val()) {
                depositoryName = $("#depositoryName").val();
            } else {
                alert("请输入仓库名");
                return;
            }
            depositoryClassificationId = classfyIdNum;

            $.ajax({
                type: "POST",
                url: "/depository/create",
                contentType: 'application/x-www-form-urlencoded;charset=utf-8',
                async: false,
                data: {
                    depositoryName: depositoryName,
                    depositoryOwnerId: depositoryOwnerId,
                    depositoryVisible: depositoryVisible,
                    depositoryClassificationId: depositoryClassificationId,
                    tags: tags
                },
                dataType: "json",
                success: function (data) {
                    console.log(data)
                    if (data.status) {
                        var depoId = data.depositoryId;
                        console.log(depoId)
                        var fd = new FormData();
                        fd.append("depository", depoId);
                        $.ajax({
                            type: "post",
                            url: "http://101.132.112.132:8088/scu_notes/create/depository.do",
                            data: {
                                depository: depoId
                            },
                            dataType: "json",
                            success: function (data) {
                                console.log(data)
                                if (data) {
                                    alert("创建仓库成功！")
                                }
                            },
                            error: function (e) {
                                console.log(e);
                            }
                        });
                    }
                },
                error: function (e) {
                    console.log(e);
                }
            });
        })

        $('#test').click(function () {
            $.ajax({
                type: "POST",
                url: "http://101.132.112.132:8088/scu_notes/download/commonFile.do",
                contentType: 'application/x-www-form-urlencoded;charset=utf-8',
                async: false,
                data: {
                    filePath: "wanghao/汪浩_科研能力加分表2016-2.xls"
                },
                dataType: "jsonp",
                processData: false,
                success: function (data) {
                    console.log(data)
                },
                error: function (e) {
                    console.log(e);
                }
            });
        });

        $('#toSearchName').blur(function () {
            console.log($('#toSearchName').val())
            if($('#toSearchName').val()) {
                var toSearchName = encodeURI("/searchAnswerPage?searchName=" + $('#toSearchName').val()); //使用encodeURI编码
                location.href = toSearchName;
            } else {
                alert("搜索框不能为空！");
            }
        });
    })
</script>
</body>

</html>